---
title: "Using/Specifying Reference Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using/Specifying Reference Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation
```{r setup}
library(CanEpiRisk)
```




## 1. Overview

This vignette explains how to **use the built‑in reference datasets** (baseline cancer **mortality** and **incidence** rates) and how to **provide your own** reference data in the format expected by `CanEpiRisk`. 

## 2. Quick start

---

## (1) Predefined reference data

### Regions

Both `Mortality` and `Incidence` are **lists of length 5** corresponding to WHO-like global regions:

1. `"Aus-NZ Europe Northern America"`  
2. `"Northern Africa - Western Asia"`  
3. `"Latin America and Caribbean"`  
4. `"Asia excl. Western Asia"`  
5. `"Sub-Saharan Africa"`  

Show region names:

```{r} 
names(Mortality)
names(Incidence)
```

### Sites and object structure

Each **regional element** is itself a list of **site-specific data.frames**. The names of the sites available for `Mortality` data are:

```{r}
names(Mortality[[1]])
```

The **canonical columns** of each site-specific data.frame are:

- `age` (integer, 1–100)  
- `male` (numeric)  
- `female` (numeric)

Rates are provided on a **one‑year age grid** (ages 1–100), which are **linearly interpolated** from corresponding 5‑year rates in the original source (for the highest age category (e.g., 85 or older), the rates are fixed). Some tables (e.g., `allcause`) may also include **person‑years** columns (`male_py` and `female_py`), which may be used for population-based averaging of calculated risks. 

Example (Region 1, all solid cancer mortality):

```{r}
head(Mortality[[1]]$allsolid)
tail(Mortality[[1]]$allsolid)
```

Example (Region 3, leukaemia mortality):

```{r}
head(Mortality[[3]]$leukaemia)
tail(Mortality[[3]]$leukaemia)
```

Example (Region 5, all-cause mortality with person-years):

```{r}
head(Mortality[[5]]$allcause)
tail(Mortality[[5]]$allcause)
```

### Visualizing baselines

Use `plot_refdata()` to compare site‑specific baselines across regions:

```{r}
# Lung cancer mortality across regions (legend top-left-ish)
plot_refdata(dat = Mortality, outcome = "lung", leg_pos = c(0.27, 0.95))
```


## Using reference data in risk calculations

A typical calculation needs a **site-specific baseline** and **all‑cause mortality** for the same region:

```{r}
# Example: CER for all solid cancer mortality (Region 1), female,
# 0.1 Gy at age 15, follow to age 100, ERR model
exp  <- list(agex = 15, doseGy = 0.1, sex = 2)

ref  <- list(
  baseline  = Mortality[[1]]$allsolid,  # site baseline
  mortality = Mortality[[1]]$allcause   # all-cause mortality
)

mod  <- LSS_mortality$allsolid$L       # example risk model (linear ERR)
opt  <- list(maxage = 100, err_wgt = 1, n_mcsamp = 5000)

cer  <- CER(exposure = exp, reference = ref, riskmodel = mod, option = opt)
cer * 10000
```

Notes:
- `sex` is typically coded `1 = male`, `2 = female`.
- `err_wgt = 1` yields pure **ERR**; `0` would be pure **EAR** (when available).

---

## (2) Providing your own reference data

You may replace the built‑in region lists with your own. CanEpiRisk expects a **list-of-regions**, where each region is a **named list of sites**, and each site is a **data.frame** with at least `age`, `male`, `female` columns on ages `1:100`.

### Minimal template

```r
# Build a custom region with two sites as an example
my_region <- list(
  allsolid = data.frame(
    age    = 1:100,
    male   = rep(0, 100),  # replace with your rates
    female = rep(0, 100)
  ),
  allcause = data.frame(
    age       = 1:100,
    male      = rep(0, 100),
    female    = rep(0, 100),
    male_py   = rep(NA_real_, 100),   # optional
    female_py = rep(NA_real_, 100)    # optional
  )
)

```


## Age distribution

`CanEpiRisk` has an list object `agedist_rgn` which contains information about the age distribution for each of the WHO global regions. `agedist_rgn` is used to compute the population-averaged risks using functions `population_CER` and `population_YLL`. The age distribution for a WHO global region can be plotted by using function `plot_agedist()` as below.

```{r}
# Example: age distributions for Regions 1 and 5
 plot_agedist( regions=c(1,3,5) )
```

---

## 3. Notes

- **Units:** Rates should be **per person-year** on the age grid. If your sources are in 5‑year groups, aggregate or **interpolate** to ages 1–100 to match the package convention.

---


## 4. See also

- Package overview vignette and risk‑model vignette for how baselines are consumed in `CER()` and related functions.




