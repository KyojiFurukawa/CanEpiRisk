---
title: "Using/Specifying Risk Models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using/Specifying Risk Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Installation

```{r setup}
library(CanEpiRisk)
```






## 1. Overview

`CanEpiRisk` supports two ways to supply risk models for lifetime risk (CER, YLL) and related computations:

1. **Predefined models** from the Life Span Study (LSS) of the Japanese atomic-bomb survivors for **mortality** and **incidence**:
   - `LSS_mortality` (mortality)
   - `LSS_incidence` (incidence)
2. **User-specified models**, provided as a list with the components:
   - `para`: numeric vector of parameter estimates
   - `var`:  variance–covariance matrix of `para`
   - `f(beta, data, lag)`: function returning the ERR/EAR given parameters `beta`, a `data` frame, and a minimum latency `lag`

The predefined models cover standard **ERR** (excess relative rate) and **EAR** (excess absolute rate) formulations for multiple cancer sites. The typical data fields expected by the model functions are:

- `dose` (e.g., Gy), `age` (attained age), `agex` (age at exposure), and `sex` (1 = male, 2 = female).

> **Notes**
> - Use `lag` to enforce a minimum latency between exposure and attained age (e.g., 5 y for solid cancers, 2 y for leukaemia).
> - Model objects are organized by **site** and **dose–response form** (e.g., `L` = linear, `LQ` = linear–quadratic), and each has `err` and/or `ear` entries.

## (1) Predefined risk models

### Mortality (LSS)

```{r mortality-list, eval=TRUE}
names(LSS_mortality)                 # sites with available mortality models
names(LSS_mortality$allsolid)        # available dose–response forms for all solid
LSS_mortality$allsolid$L$err$para    # parameter vector (example)
LSS_mortality$allsolid$L$err$var     # variance–covariance matrix (example)
LSS_mortality$allsolid$L$err$f       # ERR function
```

Plot an example (all solid, **linear ERR**):

```{r mortality-plot, eval=TRUE}
plot_riskmodel(
  rm    = LSS_mortality$allsolid$L,
  title = "LSS all solid cancer mortality — Linear",
  leg_pos = c(0.4, 0.95)
)
```

### Incidence (LSS)

```{r incidence-list, eval=TRUE}
names(LSS_incidence)                 # sites with available incidence models
names(LSS_incidence$allsolid)        # available dose–response forms for all solid
LSS_incidence$allsolid$L$err$para    # parameter vector (example)
LSS_incidence$allsolid$L$err$var     # variance–covariance matrix (example)
LSS_incidence$allsolid$L$err$f       # ERR function
```

Plot an example (all solid, **linear ERR**):

```{r incidence-plot, eval=TRUE}
plot_riskmodel(
  rm    = LSS_incidence$allsolid$L,
  title = "LSS all solid cancer incidence — Linear",
  leg_pos = c(0.4, 0.95)
)
```

## (2) User-specified risk models

You can define a model for any endpoint by supplying a list with the required components. Below is a **template** for a linear ERR model using the common covariates; adapt as needed.

```{r custom-template, eval=FALSE}
my_err_fun <- function(beta, data, lag = 5) {
  # beta: parameter vector
  # data: data.frame with columns dose, age, agex, sex (1=male, 2=female)
  # lag : minimum latency (years)
  # Example linear in dose with modifiers:
  out <- exp(beta[1]) * data$dose *
         exp(beta[2] * (data$agex - 30) / 10 + beta[3] * log(data$age / 70)) *
         (1 + c(-1, 1)[data$sex] * beta[4]) *
         (data$age - data$agex >= lag)
  return(out)
}

my_model <- list(
  para = c(-0.86, -0.35, -0.86, 0.34),   # example values
  var  = diag(c(0.01, 0.01, 0.18, 0.008)),# example diagonal VCOV
  err  = list(para = c(-0.86, -0.35, -0.86, 0.34),
              var  = diag(c(0.01, 0.01, 0.18, 0.008)),
              f    = my_err_fun)
  # optionally: ear = list(para=..., var=..., f=...)
)
```

> **Tip**: Keep the parameter order in `para` consistent with how you index inside `f()`. 


## 2. Example

As an example, the following shows how to specify the risk models on derived from the INWORKS cohort for mortality from all solid cancer (Richardson et al., 2015) and from leukaemia (Leuraud et al., 2015). Note that the uncertainty in the only risk model parameter (ERR/Gy) is specified by the 95% confidence interval, instead of the variance-covariance matrix in the LSS risk models objects.

```{r}
INWORKS_mortality <- NULL
INWORKS_mortality$allsolid <- NULL

INWORKS_mortality$allsolid$L <- list(
     err=list(
       para=c(0.47),                  # ERR/Gy=0.47 (90% CI: 0.18,0.79)  
       ci= c(0.1392403, 0.8521128),   #  95% CI coverted from 90%CI by Weibull approx.
       f=function (beta, data, lag=10) {
           beta[1] * data$dose  * (data$age - data$agex >= lag )
       }
       ),
      ear=list(    # dummry object
       para=c(4.8/10000),
       ci= c(0.1068428, 12.5703871)/10000,
       f=function (beta, data, lag=10) {
           beta[1] * data$dose  * (data$age - data$agex >= lag )
       } 
       )
 
  )

INWORKS_mortality$leukaemia$L <- list(
     err=list(
       para=c(2.96),                         # ERR/Gy=2.96 (90% CI: 1.17, 5.21) 
       ci= c(0.8664, 5.6940),
       f=function (beta, data, lag=2) {
           beta[1] * data$dose  * (data$age - data$agex >= lag )
       }
       ),
      ear=list(    # dummry object
       para=c(2.25/10000),
       ci=c(0.5064054, 4.4914628)/10000,
       f=function (beta, data, lag=2) {
           beta[1] * data$dose  * (data$age - data$agex >= lag )
       } 
       )
  )
INWORKS_mortality

# Plotting solid cancer mortality risk, male, 
#          6.7(100/15)mGy at ages 30-45, followed up to age 60, LSS-L, LSS-LQ and INWORKS models

exp4 <- list( agex=30:44+0.5, doseGy=rep(0.1/15,15), sex=1 )   # Exposure scenario
opt4_err <- list( maxage=90, err_wgt=1 )    # for ERR transfer
opt4_ear <- list( maxage=90, err_wgt=0 )    # for EAR transfer

lss_err_L  <- Comp_Exrisk( exposure=exp4, riskmodel=LSS_mortality$allsolid$L,     option=opt4_err )
lss_err_LQ <- Comp_Exrisk( exposure=exp4, riskmodel=LSS_mortality$allsolid$LQ,    option=opt4_err )
inw_err_L  <- Comp_Exrisk( exposure=exp4, riskmodel=INWORKS_mortality$allsolid$L, option=opt4_err )

lss_ear_L  <- Comp_Exrisk( exposure=exp4, riskmodel=LSS_mortality$allsolid$L,     option=opt4_ear, per=10^4 )
lss_ear_LQ <- Comp_Exrisk( exposure=exp4, riskmodel=LSS_mortality$allsolid$LQ,    option=opt4_ear, per=10^4 )
inw_ear_L  <- Comp_Exrisk( exposure=exp4, riskmodel=INWORKS_mortality$allsolid$L, option=opt4_ear, per=10^4 )

plot( c(30,90), c(0,0.1), type="n", ylab="Excess relative rate", xlab="age (years)" )
lines( lss_err_L, lty=2 )
lines( lss_err_LQ, lty=3 )
lines( inw_err_L )

plot( c(30,90), c(0,5), type="n", ylab="Excess absolute rate (cases per 10,000 person years)", xlab="age (years)" )
lines( lss_ear_L, lty=2 )
lines( lss_ear_LQ, lty=3 )
lines( inw_ear_L )
```



## References

Richardson, D.B., E. Cardis, R.D. Daniels et al. Risk of cancer from occupational exposure to ionising radiation: retrospective cohort study of workers in France, the United Kingdom, and the United States (INWORKS). BMJ 351: h5359 (2015).

Richardson, D.B., K. Leuraud, D. Laurier et al. Cancer mortality after low dose exposure to ionising radiation in workers in France, the United Kingdom, and the United States (INWORKS): cohort study. BMJ 382: e074520 (2023).

Leuraud, K., D.B. Richardson, E. Cardis et al. Ionising radiation and risk of death from leukaemia and lymphoma in radiation-monitored workers (INWORKS): an international cohort study. Lancet Haematol 2(7): e276-281 (2015).
